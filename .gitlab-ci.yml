image: node:16

variables:
  DEPLOY_HOST: 37.32.21.139

stages:
  - deploy

cache:
  paths:
    - node_modules
deploy:
  stage: deploy
  before_script:
    - 'command -v ssh-agent >/dev/null || ( apt-get update -y && apt-get install openssh-client -y )'
    - eval $(ssh-agent -s)
    - echo "${SSH_PRIVATE_KEY}" | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $DEPLOY_HOST >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - cd ~ &&
      cd /var/www/light_is_everything_front &&
      git pull &&
      docker compose down &&
      docker compose up

  only:
    - main
  tags:
    - light_is_everything
